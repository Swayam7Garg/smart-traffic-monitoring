@startuml Traffic Data Schema

title 3.6.1 Schema Definitions - MongoDB Collections

skinparam backgroundColor #FEFEFE
skinparam class {
    BackgroundColor #E8F5E9
    BorderColor #4CAF50
    ArrowColor #2E7D32
}

' Traffic Data Collection
class traffic_data {
    **Collection: traffic_data**
    ━━━━━━━━━━━━━━━━━━━━━━
    + _id: ObjectId
    + camera_id: String
    + timestamp: DateTime
    + direction: String
    + vehicle_counts: Object {
        + car: Integer
        + motorcycle: Integer
        + truck: Integer
        + bus: Integer
        + auto_rickshaw: Integer
        + bicycle: Integer
        + emergency: Integer
    }
    + total_vehicles: Integer
    + congestion_level: Float [0-100]
    + traffic_state: String
    + average_speed: Float
    + density_score: Float
    ━━━━━━━━━━━━━━━━━━━━━━
    **Indexes:**
    • camera_id + timestamp
    • timestamp (TTL: 90 days)
}

' Cameras Collection
class cameras {
    **Collection: cameras**
    ━━━━━━━━━━━━━━━━━━━━━━
    + _id: ObjectId
    + camera_id: String [unique]
    + name: String
    + direction: String
    + location: Object {
        + latitude: Float
        + longitude: Float
        + address: String
    }
    + rtsp_url: String
    + status: String
    + resolution: String
    + fps: Integer
    + is_active: Boolean
    + last_heartbeat: DateTime
    + created_at: DateTime
    + updated_at: DateTime
    ━━━━━━━━━━━━━━━━━━━━━━
    **Indexes:**
    • camera_id (unique)
    • direction
    • is_active
}

' Emergency Events Collection
class emergency_events {
    **Collection: emergency_events**
    ━━━━━━━━━━━━━━━━━━━━━━
    + _id: ObjectId
    + event_id: String [unique]
    + camera_id: String
    + timestamp: DateTime
    + direction: String
    + vehicle_type: String
    + confidence: Float [0-1]
    + detection_method: String
    + priority_level: Integer [1-5]
    + status: String
    + response_time: Float (seconds)
    + bbox: Object {
        + x1: Integer
        + y1: Integer
        + x2: Integer
        + y2: Integer
    }
    + frame_snapshot: String (path)
    + resolved_at: DateTime
    ━━━━━━━━━━━━━━━━━━━━━━
    **Indexes:**
    • event_id (unique)
    • camera_id + timestamp
    • status
}

' Signal Timings Collection
class signal_timings {
    **Collection: signal_timings**
    ━━━━━━━━━━━━━━━━━━━━━━
    + _id: ObjectId
    + timing_id: String
    + intersection_id: String
    + timestamp: DateTime
    + mode: String
    + signals: Object {
        + north: Object {
            + state: String
            + duration: Integer
            + next_change: DateTime
        }
        + south: Object {...}
        + east: Object {...}
        + west: Object {...}
    }
    + cycle_length: Integer
    + algorithm_used: String
    + efficiency_score: Float
    + override_reason: String
    ━━━━━━━━━━━━━━━━━━━━━━
    **Indexes:**
    • intersection_id + timestamp
    • mode
}

' Analytics Collection
class analytics {
    **Collection: analytics**
    ━━━━━━━━━━━━━━━━━━━━━━
    + _id: ObjectId
    + report_id: String [unique]
    + report_type: String
    + start_date: DateTime
    + end_date: DateTime
    + camera_ids: Array<String>
    + aggregated_data: Object {
        + total_vehicles: Integer
        + peak_hours: Array
        + average_congestion: Float
        + vehicle_distribution: Object
        + daily_trends: Array
    }
    + insights: Array<String>
    + generated_at: DateTime
    + generated_by: String
    + file_path: String (PDF/Excel)
    ━━━━━━━━━━━━━━━━━━━━━━
    **Indexes:**
    • report_id (unique)
    • report_type
    • start_date + end_date
}

' Violations Collection
class violations {
    **Collection: violations**
    ━━━━━━━━━━━━━━━━━━━━━━
    + _id: ObjectId
    + violation_id: String [unique]
    + camera_id: String
    + timestamp: DateTime
    + violation_type: String
    + vehicle_type: String
    + vehicle_plate: String
    + confidence: Float
    + evidence: Object {
        + frame_path: String
        + video_clip: String
        + bbox: Object
    }
    + location: String
    + fine_amount: Float
    + status: String
    + issued_at: DateTime
    ━━━━━━━━━━━━━━━━━━━━━━
    **Indexes:**
    • violation_id (unique)
    • camera_id + timestamp
    • vehicle_plate
    • status
}

' Relationships
traffic_data "1" -- "1" cameras : "belongs_to"
emergency_events "1" -- "1" cameras : "detected_by"
signal_timings "1" -- "*" emergency_events : "triggered_by"
analytics "*" -- "*" traffic_data : "aggregates"
violations "1" -- "1" cameras : "recorded_by"

@enduml

' ==================== E-R DIAGRAM ====================

@startuml E-R Diagram
!define TABLE class

title 3.6.2 Entity-Relationship Diagram - Complete Database Model

skinparam backgroundColor #FEFEFE
skinparam class {
    BackgroundColor #E3F2FD
    BorderColor #1976D2
    ArrowColor #0D47A1
}
skinparam roundcorner 10

' ==================== ENTITIES ====================

entity Camera {
    **CAMERA**
    ━━━━━━━━━━━━━━━━━━
    • **camera_id** : PK
    --
    name : String
    direction : Enum
    location : GeoJSON
    rtsp_url : String
    status : Enum
    resolution : String
    fps : Integer
    is_active : Boolean
    last_heartbeat : DateTime
    created_at : DateTime
    updated_at : DateTime
}

entity TrafficData {
    **TRAFFIC_DATA**
    ━━━━━━━━━━━━━━━━━━
    • **_id** : PK
    • camera_id : FK
    --
    timestamp : DateTime
    direction : String
    vehicle_counts : JSON
    total_vehicles : Integer
    congestion_level : Float
    traffic_state : Enum
    average_speed : Float
    density_score : Float
}

entity EmergencyEvent {
    **EMERGENCY_EVENT**
    ━━━━━━━━━━━━━━━━━━
    • **event_id** : PK
    • camera_id : FK
    --
    timestamp : DateTime
    direction : String
    vehicle_type : String
    confidence : Float
    detection_method : String
    priority_level : Integer
    status : Enum
    response_time : Float
    bbox : JSON
    frame_snapshot : String
    resolved_at : DateTime
}

entity SignalTiming {
    **SIGNAL_TIMING**
    ━━━━━━━━━━━━━━━━━━
    • **timing_id** : PK
    • intersection_id : String
    --
    timestamp : DateTime
    mode : Enum
    signals : JSON
    cycle_length : Integer
    algorithm_used : String
    efficiency_score : Float
    override_reason : String
}

entity Analytics {
    **ANALYTICS**
    ━━━━━━━━━━━━━━━━━━
    • **report_id** : PK
    --
    report_type : Enum
    start_date : DateTime
    end_date : DateTime
    camera_ids : Array
    aggregated_data : JSON
    insights : Array
    generated_at : DateTime
    generated_by : String
    file_path : String
}

entity Violation {
    **VIOLATION**
    ━━━━━━━━━━━━━━━━━━
    • **violation_id** : PK
    • camera_id : FK
    --
    timestamp : DateTime
    violation_type : Enum
    vehicle_type : String
    vehicle_plate : String
    confidence : Float
    evidence : JSON
    location : String
    fine_amount : Float
    status : Enum
    issued_at : DateTime
}

entity Intersection {
    **INTERSECTION**
    ━━━━━━━━━━━━━━━━━━
    • **intersection_id** : PK
    --
    name : String
    location : GeoJSON
    type : String
    num_directions : Integer
    is_active : Boolean
    created_at : DateTime
}

entity User {
    **USER**
    ━━━━━━━━━━━━━━━━━━
    • **user_id** : PK
    --
    username : String
    email : String
    password_hash : String
    role : Enum
    full_name : String
    created_at : DateTime
    last_login : DateTime
    is_active : Boolean
}

' ==================== RELATIONSHIPS ====================

Camera "1" -- "0..*" TrafficData : generates >
Camera "1" -- "0..*" EmergencyEvent : detects >
Camera "1" -- "0..*" Violation : captures >
Camera "0..*" -- "1" Intersection : monitors <

EmergencyEvent "0..*" -- "1" SignalTiming : triggers >

Analytics "1" -- "0..*" TrafficData : aggregates >
Analytics "0..*" -- "1" User : generated_by <

SignalTiming "0..*" -- "1" Intersection : controls <

User "1" -- "0..*" Analytics : creates >

' ==================== CARDINALITY NOTES ====================

note right of Camera
  **Camera Entity**
  • One camera generates multiple traffic data records
  • One camera can detect multiple emergency events
  • One camera captures multiple violations
  • Multiple cameras monitor one intersection
end note

note right of EmergencyEvent
  **Emergency Priority System**
  • Detection triggers immediate signal override
  • Response time tracked for each event
  • Priority levels: 1 (Critical) to 5 (Low)
end note

note bottom of SignalTiming
  **Adaptive Signal Control**
  • Calculated based on real-time traffic density
  • Three modes: Adaptive, Emergency, Manual
  • Formula: Green_Time = (Vehicle_Count / Total) × Max_Time
  
  **Constraints:**
  • Min Green: 15 seconds
  • Max Green: 120 seconds
  • Yellow: 5 seconds (fixed)
end note

note left of Analytics
  **Analytics Aggregation**
  • Daily, Weekly, Monthly reports
  • Aggregates data from multiple cameras
  • Generates PDF/Excel reports
  • Stores in data/outputs/
end note

' ==================== DATA FLOW NOTES ====================

note as DataFlow
  **Data Flow Sequence**
  
  1. Camera captures video stream
  2. YOLOv8 detects vehicles → TrafficData
  3. Emergency detector scans → EmergencyEvent
  4. Signal controller adjusts → SignalTiming
  5. Analytics aggregates → Reports
  6. Violations logged → Violation records
end note

@enduml

' ==================== DETAILED SCHEMA WITH CONSTRAINTS ====================

@startuml Schema Constraints and Validation
title 3.6.1 MongoDB Schema Validation Rules

skinparam backgroundColor #FEFEFE
skinparam class {
    BackgroundColor #FFF3E0
    BorderColor #F57C00
}

class SchemaValidation {
    **MongoDB JSON Schema Validation**
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    **traffic_data Collection:**
    {
      $jsonSchema: {
        bsonType: "object",
        required: ["camera_id", "timestamp", 
                   "vehicle_counts", "total_vehicles"],
        properties: {
          camera_id: { bsonType: "string" },
          timestamp: { bsonType: "date" },
          congestion_level: { 
            bsonType: "double",
            minimum: 0,
            maximum: 100
          },
          traffic_state: {
            enum: ["light", "moderate", 
                   "heavy", "congested"]
          },
          vehicle_counts: {
            bsonType: "object",
            required: ["car", "motorcycle"],
            properties: {
              car: { bsonType: "int", minimum: 0 },
              motorcycle: { bsonType: "int", minimum: 0 },
              truck: { bsonType: "int", minimum: 0 },
              bus: { bsonType: "int", minimum: 0 },
              auto_rickshaw: { bsonType: "int", minimum: 0 },
              bicycle: { bsonType: "int", minimum: 0 },
              emergency: { bsonType: "int", minimum: 0 }
            }
          }
        }
      }
    }
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    **emergency_events Collection:**
    {
      $jsonSchema: {
        bsonType: "object",
        required: ["event_id", "camera_id", 
                   "timestamp", "confidence"],
        properties: {
          event_id: { 
            bsonType: "string",
            pattern: "^EMG-[0-9]{10}-[A-Z0-9]{6}$"
          },
          confidence: { 
            bsonType: "double",
            minimum: 0,
            maximum: 1
          },
          priority_level: {
            bsonType: "int",
            minimum: 1,
            maximum: 5
          },
          status: {
            enum: ["detected", "active", 
                   "resolved", "cancelled"]
          }
        }
      }
    }
    ━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    
    **cameras Collection:**
    {
      $jsonSchema: {
        bsonType: "object",
        required: ["camera_id", "name", 
                   "direction", "rtsp_url"],
        properties: {
          camera_id: {
            bsonType: "string",
            pattern: "^CAM-[0-9]{4}$"
          },
          direction: {
            enum: ["north", "south", "east", "west"]
          },
          status: {
            enum: ["online", "offline", 
                   "maintenance", "error"]
          },
          fps: {
            bsonType: "int",
            minimum: 1,
            maximum: 60
          }
        }
      }
    }
}

@enduml

' ==================== CLASS DIAGRAM ====================

@startuml Class Diagram
title 3.6.3 Class Diagram - System Classes

skinparam backgroundColor #FEFEFE
skinparam classAttributeIconSize 0
skinparam roundcorner 10

' ==================== ML/AI CLASSES ====================

class VehicleDetector {
    - model: YOLO
    - confidence: float
    - device: str
    __
    + __init__(model_path: str)
    + detect(frame: ndarray): List[Detection]
    + preprocess(frame: ndarray): ndarray
    + postprocess(results): List[Detection]
}

class Detection {
    + bbox: Tuple[int]
    + class_name: str
    + confidence: float
    + class_id: int
    __
    + get_area(): int
    + get_center(): Tuple[int]
}

' ==================== INTELLIGENCE CLASSES ====================

class TrafficAnalyzer {
    - congestion_threshold: int
    __
    + analyze(detections: List): TrafficStats
    + calculate_density(count: int): float
    + get_traffic_state(density: float): str
    + count_by_type(detections: List): Dict
}

class EmergencyDetector {
    - confidence_threshold: float
    __
    + detect_emergency(frame: ndarray): bool
    + check_color_pattern(hsv: ndarray): bool
    + validate_vehicle(detection: Detection): bool
}

class SignalController {
    - min_green: int
    - max_green: int
    - yellow_time: int
    __
    + calculate_timing(traffic: Dict): Dict
    + handle_emergency(direction: str): Dict
    + update_signals(): void
}

' ==================== DATA MODELS ====================

class Camera {
    + camera_id: str
    + name: str
    + direction: str
    + rtsp_url: str
    + status: str
    + is_active: bool
    __
    + connect(): bool
    + get_frame(): ndarray
    + disconnect(): void
}

class TrafficData {
    + camera_id: str
    + timestamp: datetime
    + vehicle_counts: Dict
    + total_vehicles: int
    + congestion_level: float
    + traffic_state: str
    __
    + save_to_db(): void
    + to_dict(): Dict
}

class EmergencyEvent {
    + event_id: str
    + camera_id: str
    + timestamp: datetime
    + confidence: float
    + priority_level: int
    + status: str
    __
    + trigger_response(): void
    + resolve(): void
}

' ==================== SERVICE CLASSES ====================

class VideoProcessor {
    - detector: VehicleDetector
    - analyzer: TrafficAnalyzer
    - emergency_detector: EmergencyDetector
    __
    + process_video(video_path: str): Result
    + process_frame(frame: ndarray): FrameResult
    + save_results(): void
}

class DatabaseService {
    - client: AsyncIOMotorClient
    - db: Database
    __
    + insert_traffic_data(data: Dict): ObjectId
    + get_camera(camera_id: str): Camera
    + update_signal_timing(timing: Dict): void
    + aggregate_analytics(filters: Dict): Dict
}

class WebSocketManager {
    - connections: List[WebSocket]
    __
    + connect(websocket: WebSocket): void
    + disconnect(websocket: WebSocket): void
    + broadcast(message: Dict): void
}

' ==================== RELATIONSHIPS ====================

VehicleDetector "1" --> "*" Detection : creates
VideoProcessor "1" --> "1" VehicleDetector : uses
VideoProcessor "1" --> "1" TrafficAnalyzer : uses
VideoProcessor "1" --> "1" EmergencyDetector : uses

TrafficAnalyzer "1" --> "1" TrafficData : generates
EmergencyDetector "1" --> "1" EmergencyEvent : creates

SignalController "1" --> "*" TrafficData : reads
SignalController "1" --> "*" EmergencyEvent : responds_to

Camera "1" --> "*" TrafficData : generates
Camera "1" --> "*" EmergencyEvent : detects

VideoProcessor "1" --> "1" DatabaseService : uses
WebSocketManager "1" --> "1" DatabaseService : uses

' ==================== NOTES ====================

note right of VehicleDetector
  **YOLOv8 Integration**
  • Loads yolov8n.pt model
  • Confidence threshold: 0.15
  • Processes 30 FPS
  • GPU/CPU support
end note

note right of SignalController
  **Adaptive Algorithm**
  Calculates optimal green time
  based on vehicle density
  
  Formula:
  Green = (Count/Total) × Max
end note

note bottom of DatabaseService
  **Async MongoDB Operations**
  • Motor async driver
  • Connection pooling
  • CRUD operations
  • Aggregation pipelines
end note

@enduml
